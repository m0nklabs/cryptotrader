name: Auto-assign Copilot to Priority Issues

on:
  # Run every 2 hours
  schedule:
    - cron: '0 */2 * * *'
  # Manual trigger
  workflow_dispatch:
  # Run when a PR is closed (to assign next issue)
  pull_request:
    types: [closed]

permissions:
  issues: write
  pull-requests: read
  contents: read

jobs:
  assign-copilot:
    runs-on: ubuntu-latest
    steps:
      - name: Generate App Token
        id: generate-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Check for active Copilot PRs
        id: check-prs
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            // Find open PRs by Copilot
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const copilotPRs = prs.filter(pr =>
              pr.user.login === 'copilot[bot]' ||
              pr.user.login === 'Copilot' ||
              pr.user.login === 'app/copilot-swe-agent' ||
              pr.user.login.toLowerCase().includes('copilot')
            );

            console.log(`Found ${copilotPRs.length} active Copilot PRs`);

            if (copilotPRs.length > 0) {
              console.log('Copilot is busy, skipping assignment');
              core.setOutput('busy', 'true');
              return;
            }

            core.setOutput('busy', 'false');

      - name: Find highest priority unassigned issue
        id: find-issue
        if: steps.check-prs.outputs.busy == 'false'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            // Priority order for EPICs (highest first)
            const epicPriority = {
              71: 1,  // Trading System (core functionality)
              70: 2,  // Market Data (data pipeline)
              69: 3,  // Technical Analysis
              68: 4,  // Infrastructure
              76: 5   // Frontend & UI
            };

            // Priority labels (if present, use these)
            const labelPriority = {
              'priority:critical': 0,
              'priority:high': 1,
              'priority:medium': 2,
              'priority:low': 3
            };

            // Get all open issues
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            // Filter: not a PR, not an EPIC, has label 'copilot' for eligibility
            const candidates = issues.filter(issue => {
              // Skip PRs
              if (issue.pull_request) return false;

              // Skip EPICs (have ðŸŽ¯ in title)
              if (issue.title.includes('ðŸŽ¯') || issue.title.includes('EPIC')) return false;

              // Must have 'copilot' label to be eligible for auto-assignment
              const labels = issue.labels.map(l => l.name.toLowerCase());
              if (!labels.includes('copilot')) return false;

              // Skip issues with [blocked] or [wip] in title
              const titleLower = issue.title.toLowerCase();
              if (titleLower.includes('[blocked]') || titleLower.includes('[wip]')) return false;

              return true;
            });

            if (candidates.length === 0) {
              console.log('No unassigned issues found');
              core.setOutput('found', 'false');
              return;
            }

            // Score each issue
            const scoredIssues = candidates.map(issue => {
              let score = 1000; // Base score

              // Check for priority labels
              for (const label of issue.labels) {
                const labelName = label.name.toLowerCase();
                if (labelPriority[labelName] !== undefined) {
                  score = labelPriority[labelName] * 100;
                  break;
                }
              }

              // Check issue body for EPIC reference
              const body = issue.body || '';
              const epicMatch = body.match(/EPIC #(\d+)/i);
              if (epicMatch) {
                const epicNum = parseInt(epicMatch[1]);
                if (epicPriority[epicNum]) {
                  score += epicPriority[epicNum];
                }
              }

              // Prefer older issues (lower number = older = higher priority)
              score += issue.number / 1000;

              return { issue, score };
            });

            // Sort by score (lowest = highest priority)
            scoredIssues.sort((a, b) => a.score - b.score);

            const topIssue = scoredIssues[0].issue;
            console.log(`Selected issue #${topIssue.number}: ${topIssue.title}`);
            console.log(`Score: ${scoredIssues[0].score}`);

            core.setOutput('found', 'true');
            core.setOutput('issue_number', topIssue.number);
            core.setOutput('issue_title', topIssue.title);

      - name: Assign Copilot to issue (GraphQL)
        if: steps.check-prs.outputs.busy == 'false' && steps.find-issue.outputs.found == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const issueNumber = ${{ steps.find-issue.outputs.issue_number }};
            const issueTitle = `${{ steps.find-issue.outputs.issue_title }}`;

            console.log(`Assigning Copilot to issue #${issueNumber}: ${issueTitle}`);

            // Step 1: Find the Copilot bot in suggested actors
            // This is required because Copilot can't be assigned via normal API
            let copilotBotId = null;
            let endCursor = null;

            while (!copilotBotId) {
              const suggestedActorsQuery = `
                query($owner: String!, $name: String!, $endCursor: String) {
                  repository(owner: $owner, name: $name) {
                    suggestedActors(first: 100, after: $endCursor, capabilities: CAN_BE_ASSIGNED) {
                      nodes {
                        ... on Bot {
                          id
                          login
                        }
                      }
                      pageInfo {
                        hasNextPage
                        endCursor
                      }
                    }
                  }
                }
              `;

              const suggestedResult = await github.graphql(suggestedActorsQuery, {
                owner: context.repo.owner,
                name: context.repo.repo,
                endCursor: endCursor
              });

              for (const node of suggestedResult.repository.suggestedActors.nodes) {
                if (node.login === 'copilot-swe-agent') {
                  copilotBotId = node.id;
                  break;
                }
              }

              if (!suggestedResult.repository.suggestedActors.pageInfo.hasNextPage) {
                break;
              }
              endCursor = suggestedResult.repository.suggestedActors.pageInfo.endCursor;
            }

            if (!copilotBotId) {
              core.setFailed('Copilot bot not found in suggested actors. Make sure Copilot is enabled for this repo.');
              return;
            }

            console.log(`Found Copilot bot with ID: ${copilotBotId}`);

            // Step 2: Get the issue's GraphQL ID and current assignees
            const issueQuery = `
              query($owner: String!, $name: String!, $number: Int!) {
                repository(owner: $owner, name: $name) {
                  issue(number: $number) {
                    id
                    assignees(first: 100) {
                      nodes {
                        id
                      }
                    }
                  }
                }
              }
            `;

            const issueResult = await github.graphql(issueQuery, {
              owner: context.repo.owner,
              name: context.repo.repo,
              number: issueNumber
            });

            const issueId = issueResult.repository.issue.id;
            const currentAssigneeIds = issueResult.repository.issue.assignees.nodes.map(n => n.id);

            console.log(`Issue ID: ${issueId}, Current assignees: ${currentAssigneeIds.length}`);

            // Step 3: Assign Copilot using replaceActorsForAssignable mutation
            // This adds Copilot while keeping existing assignees
            const actorIds = [...currentAssigneeIds, copilotBotId];

            const assignMutation = `
              mutation($input: ReplaceActorsForAssignableInput!) {
                replaceActorsForAssignable(input: $input) {
                  assignable {
                    ... on Issue {
                      assignees(first: 10) {
                        nodes {
                          login
                        }
                      }
                    }
                  }
                }
              }
            `;

            const assignResult = await github.graphql(assignMutation, {
              input: {
                assignableId: issueId,
                actorIds: actorIds
              }
            });

            const newAssignees = assignResult.replaceActorsForAssignable.assignable.assignees.nodes
              .map(n => n.login).join(', ');
            console.log(`Successfully assigned! New assignees: ${newAssignees}`);

            core.setOutput('assigned', 'true');

      - name: Mention Copilot on issue
        if: steps.check-prs.outputs.busy == 'false' && steps.find-issue.outputs.found == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const issueNumber = ${{ steps.find-issue.outputs.issue_number }};

            // Post @copilot comment to trigger the agent to start work
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: '@copilot Please implement this issue. Create a fresh branch from current master and open a PR when ready.\n\n_Auto-triggered by CI (no active Copilot PRs detected)_'
            });

            console.log(`Mentioned Copilot on issue #${issueNumber}`);

      - name: Summary
        if: always()
        run: |
          echo "### Copilot Auto-Assignment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-prs.outputs.busy }}" == "true" ]; then
            echo "â³ Copilot is currently busy with an open PR" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.find-issue.outputs.found }}" == "true" ]; then
            echo "âœ… Assigned Copilot to issue #${{ steps.find-issue.outputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**${{ steps.find-issue.outputs.issue_title }}**" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“­ No unassigned issues found" >> $GITHUB_STEP_SUMMARY
          fi
