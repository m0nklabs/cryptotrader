name: Copilot CI Feedback

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  pull-requests: write

jobs:
  notify-copilot:
    if: github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.pull_requests[0] != null
    runs-on: ubuntu-latest
    steps:
      - name: Get PR details
        id: pr
        run: |
          PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # Check if PR is from Copilot (case-insensitive)
          PR_AUTHOR=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER --jq '.user.login')
          echo "author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          PR_AUTHOR_LOWER=$(echo "$PR_AUTHOR" | tr '[:upper:]' '[:lower:]')

          if [[ "$PR_AUTHOR_LOWER" == *"copilot"* ]]; then
            echo "is_copilot=true" >> $GITHUB_OUTPUT
          else
            echo "is_copilot=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Check for recent @copilot comments (spam prevention)
        if: steps.pr.outputs.is_copilot == 'true'
        id: spam_check
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          # Get comments from the last 10 minutes containing @copilot
          RECENT_COPILOT_COMMENTS=$(gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments \
            --jq '[.[] | select(.body | contains("@copilot")) | select(.created_at > (now - 600 | strftime("%Y-%m-%dT%H:%M:%SZ")))] | length')

          echo "recent_comments=$RECENT_COPILOT_COMMENTS" >> $GITHUB_OUTPUT

          if [ "$RECENT_COPILOT_COMMENTS" -ge 1 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping - already posted @copilot comment in last 10 minutes"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Get failed jobs
        if: steps.pr.outputs.is_copilot == 'true' && steps.spam_check.outputs.skip != 'true'
        id: failures
        run: |
          RUN_ID="${{ github.event.workflow_run.id }}"

          # Get failed jobs and their logs
          FAILED_JOBS=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs \
            --jq '[.jobs[] | select(.conclusion == "failure") | .name] | join(", ")')

          echo "jobs=$FAILED_JOBS" >> $GITHUB_OUTPUT

          # Get run URL
          echo "url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Comment on PR to notify Copilot
        if: steps.pr.outputs.is_copilot == 'true' && steps.spam_check.outputs.skip != 'true'
        env:
          # Must use PAT - Copilot only responds to user comments, not bot comments
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          FAILED_JOBS="${{ steps.failures.outputs.jobs }}"
          RUN_URL="${{ steps.failures.outputs.url }}"

          # Build comment body - avoid YAML special chars
          cat <<EOF > /tmp/comment.md
          @copilot CI checks failed. Please fix the following:

          Failed checks: $FAILED_JOBS

          [View workflow run]($RUN_URL)

          _Auto-feedback from CI_
          EOF

          gh pr comment "$PR_NUMBER" --repo "${{ github.repository }}" --body-file /tmp/comment.md

          echo "Notified Copilot about CI failure on PR #$PR_NUMBER"
