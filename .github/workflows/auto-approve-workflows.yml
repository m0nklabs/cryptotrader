name: Auto-approve Copilot Workflows

on:
  schedule:
    # Run every 2 minutes to quickly approve pending workflows
    - cron: "*/2 * * * *"
  workflow_dispatch:

jobs:
  auto-approve:
    name: Auto-approve pending workflow runs
    runs-on: ubuntu-latest
    steps:
      - name: Approve pending workflow runs from copilot-swe-agent
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Checking for pending workflow runs..."

          # List runs with action_required status
          PENDING=$(gh api repos/${{ github.repository }}/actions/runs \
            --jq '.workflow_runs[] | select(.status == "action_required") | {id: .id, name: .name, actor: .actor.login}' \
            2>/dev/null || echo "")

          if [ -z "$PENDING" ]; then
            echo "No pending workflow runs found."
            exit 0
          fi

          echo "Found pending runs:"
          echo "$PENDING"

          # Approve each pending run from copilot-swe-agent
          echo "$PENDING" | jq -r 'select(.actor == "copilot-swe-agent") | .id' | while read -r RUN_ID; do
            if [ -n "$RUN_ID" ]; then
              echo "Approving run $RUN_ID..."
              gh api --method POST repos/${{ github.repository }}/actions/runs/$RUN_ID/approve \
                || echo "Failed to approve run $RUN_ID (may already be approved or completed)"
            fi
          done

          echo "Done."
