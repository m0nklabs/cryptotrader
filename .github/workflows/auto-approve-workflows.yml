name: Auto-approve Copilot Workflows

on:
  schedule:
    # Run every 2 minutes to quickly approve pending workflows
    - cron: "*/2 * * * *"
  workflow_dispatch:

jobs:
  auto-approve:
    name: Re-run pending workflow runs
    runs-on: ubuntu-latest
    steps:
      - name: Re-run action_required workflow runs from Copilot
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Checking for pending workflow runs..."

          # List runs with action_required conclusion (these are stuck waiting for approval)
          # Note: status is "completed" but conclusion is "action_required"
          PENDING=$(gh api repos/${{ github.repository }}/actions/runs \
            --jq '.workflow_runs[] | select(.conclusion == "action_required") | {id: .id, name: .name, actor: .actor.login, branch: .head_branch}' \
            2>/dev/null || echo "")

          if [ -z "$PENDING" ]; then
            echo "No pending workflow runs found."
            exit 0
          fi

          echo "Found pending runs:"
          echo "$PENDING"

          # Re-run each pending run from Copilot (actor is "Copilot" for copilot-swe-agent PRs)
          echo "$PENDING" | jq -r 'select(.actor == "Copilot" or .actor == "copilot-swe-agent") | .id' | while read -r RUN_ID; do
            if [ -n "$RUN_ID" ]; then
              echo "Re-running workflow run $RUN_ID..."
              gh api --method POST repos/${{ github.repository }}/actions/runs/$RUN_ID/rerun \
                || echo "Failed to re-run $RUN_ID (may already be running or completed)"
            fi
          done

          echo "Done."
