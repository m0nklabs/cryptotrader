name: Mark Copilot PRs Ready

on:
  # Trigger when CI workflow completes
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

  # Periodic scan to avoid marking PRs ready too early.
  # This ensures we can mark older draft PRs ready even if CI finished < 1h after creation.
  schedule:
    - cron: "*/15 * * * *"

  workflow_dispatch:

jobs:
  mark-ready:
    name: Mark Copilot PR as ready for review
    runs-on: [self-hosted, Linux, org]
    # Only run if CI succeeded and it's from a Copilot branch
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'copilot/')
    steps:
      - name: Run header
        uses: m0nklabs/cryptotrader/.github/actions/run-header@master
        with:
          title: "Mark Copilot PRs Ready"

      - name: Mark PR ready for review
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          REPO="${{ github.repository }}"
          MIN_AGE_SECONDS=3600

          echo "Looking for draft PR on branch: $BRANCH"

          # Find the PR for this branch
          PR_NUMBER=$(gh pr list --repo "$REPO" --head "$BRANCH" --state open --json number,isDraft --jq '.[] | select(.isDraft == true) | .number')

          if [ -z "$PR_NUMBER" ]; then
            echo "No draft PR found for branch $BRANCH (may already be ready or merged)"
            exit 0
          fi

          CREATED_AT=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json createdAt --jq '.createdAt')
          NOW=$(date +%s)
          CREATED_TS=$(date -d "$CREATED_AT" +%s)
          AGE=$(( NOW - CREATED_TS ))
          if [ "$AGE" -lt "$MIN_AGE_SECONDS" ]; then
            echo "PR #$PR_NUMBER is too new ($AGE s < $MIN_AGE_SECONDS s). Skipping; schedule will pick it up later."
            exit 0
          fi

          echo "Found draft PR #$PR_NUMBER, marking as ready for review..."
          gh pr ready "$PR_NUMBER" --repo "$REPO"
          echo "âœ… PR #$PR_NUMBER is now ready for review"

  scan-ready:
    name: Scan Copilot draft PRs (>=1h)
    runs-on: [self-hosted, Linux, org]
    if: github.event_name != 'workflow_run'
    steps:
      - name: Mark eligible draft PRs ready
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          set -euo pipefail

          REPO="${{ github.repository }}"
          MIN_AGE_SECONDS=3600
          NOW=$(date +%s)

          PRS=$(gh pr list --repo "$REPO" --state open --json number,isDraft,createdAt,headRefName \
            --jq '[.[] | select(.isDraft == true) | select(.headRefName | startswith("copilot/"))]')

          COUNT=$(echo "$PRS" | jq 'length')
          echo "Found $COUNT open draft Copilot PR(s) to evaluate"

          echo "$PRS" | jq -c '.[]' | while read -r pr; do
            PR_NUMBER=$(echo "$pr" | jq -r '.number')
            BRANCH=$(echo "$pr" | jq -r '.headRefName')
            CREATED_AT=$(echo "$pr" | jq -r '.createdAt')

            CREATED_TS=$(date -d "$CREATED_AT" +%s)
            AGE=$(( NOW - CREATED_TS ))
            if [ "$AGE" -lt "$MIN_AGE_SECONDS" ]; then
              echo "PR #$PR_NUMBER too new ($AGE s), skip"
              continue
            fi

            # Only mark ready if latest CI run on the branch succeeded.
            CONCLUSION=$(gh run list --repo "$REPO" --workflow "CI" --branch "$BRANCH" --limit 1 --json conclusion --jq '.[0].conclusion // empty' || true)
            if [ "$CONCLUSION" != "success" ]; then
              echo "PR #$PR_NUMBER latest CI conclusion is '$CONCLUSION', skip"
              continue
            fi

            echo "Marking PR #$PR_NUMBER ready for review (age=${AGE}s, CI=success)"
            gh pr ready "$PR_NUMBER" --repo "$REPO" || true
          done
